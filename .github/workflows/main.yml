#---------------------------------------------------------------------
# Test task for Alpacked
#---------------------------------------------------------------------
name: Build-CI-CD-Pipeline
env:
  S3_BUCKET_NAME : "alpacked-test-bucket"
  APPLICATION_NAME       : "Alpacked_APP"
  ENVIRONMENT_NAME       : "App-GREEN-env"
  DEPLOY_PACKAGE_NAME       : "Alpacked_APP_${{ github.sha }}.zip"
  AWS_REGION_NAME           : "eu-west-2"

on: 
  push:
    branches: 
      - My-test-branch

jobs:
        
  Deployment:
    runs-on: ubuntu-latest
    steps:
    
    - name: Configure my AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id    :  ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key:  ${{ secrets.AWS_SECRET_KEY }}
        aws-region           :  ${{ env.AWS_REGION_NAME }} 
        
    - name: Git clone our repo to build machine
      uses: actions/checkout@v1 

    - name: Create env file
      run: |
        touch .env
        echo CONTENTFUL_SPACE_ID=${{ secrets.CONTENTFUL_SPACE_ID }}>> .env
        echo CONTENTFUL_ACCESS_TOKEN=${{ secrets.CONTENTFUL_ACCESS_TOKEN }} >> .env
        echo MAILCHIMP_ENDPOINT=${{ secrets.MAILCHIMP_link }} >> .env
        cat .env
      
    - name: Install pulumi
      uses: pulumi/action-install-pulumi-cli@v1.0.1
    - name: Setup Node
      uses: actions/setup-node@v2.1.5
      with:
        node-version: 14.x
    
    
    - run: npm i
    - run: npm install -g gatsby-cli
    - run: gatsby --version
   
    - uses: pulumi/actions@v2
      with:
        command: up
        stack-name: oleg-test
        work-dir: ./pulumi
        github-token: ${{ secrets.GH_TOKEN_FOR_PULUMI }} 
      env:
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        
    - run: gatsby build
    
    - name: Deploy Gatsby to AWS S3
      uses: jonelantha/gatsby-s3-action@v1
      with:
    # Destination S3 Bucket
       dest-s3-bucket: my-gatsby-bucket-12345
        

