#---------------------------------------------------------------------
# Test task for Alpacked
#---------------------------------------------------------------------
name: Build-CI-CD-Pipeline
env:
  S3_BUCKET_NAME : "alpacked-test-bucket"
  APPLICATION_NAME       : "Alpacked_APP"
  ENVIRONMENT_NAME       : "App-GREEN-env"
  DEPLOY_PACKAGE_NAME       : "Alpacked_APP_${{ github.sha }}.zip"
  AWS_REGION_NAME           : "eu-west-2"

on: 
  push:
    branches: 
      - My-test-branch

jobs:
        
  Deployment:
    runs-on: ubuntu-latest
    steps:
    
    - name: install node.js
      uses: actions/setup-node@v2.1.5
      with:
        node-version: 14
    
    - name: Configure my AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id    :  ${{ secrets.AWS_ACCESS_KEY }}
        aws-secret-access-key:  ${{ secrets.AWS_SECRET_KEY }}
        aws-region           :  ${{ env.AWS_REGION_NAME }} 
        
    - name: Install Pulumi CLI
      # You may pin to the exact commit or the version.
      # uses: pulumi/action-install-pulumi-cli@9502cfe40a53a21bbbeda23422d25ead8e426c1c
      uses: pulumi/action-install-pulumi-cli@v1.0.1
      with:
        # Version of the Pulumi CLI to install, or 'latest' (default).
        pulumi-version: latest

    - name: Git clone our repo to build machine
      uses: actions/checkout@v1    

#    - name: pwd
#      run: pwd
      
#    - name: ls -la
#      run: ls -la

#    - name: cd
#      run: cd /home/runner/work/gatsby-contentful-portfolio/gatsby-contentful-portfolio/pulumi
      
#    - name: ls -la
#      run: ls -la

#    - name: pulumi stack ls
#      run: pulumi stack ls 

#    - name: pulumi stack select
#      run: pulumi stack select dev
#      env:
#          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          
          
    - name: Pulumi Deploy Actions
      uses: pulumi/actions@v2
      with:
       command: up
       stack-name: oleg-test
      env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_ROOT: /pulumi
          
    - name: Print finish
      run: echo "congratulation" 
    
          
    - name: Print finish Message  
      run : echo "::core.error"
